@model Mango.Web.Areas.Admin.Models.ProductLayoutFormViewModel

@{
    ViewBag.Title = "EditLayout";
}

@section ScriptsHead
{
    <script src="@Links.Scripts.product_canvas.fabric_min_js"></script>
    <style>
        canvas {
            border: 1px solid #ccc;
        }

        .pic {
            color: green;
        }

        .text {
            color: blue;
        }
        /*logo icons*/
        .icons {
            text-align: center;
            vertical-align: middle;
        }

            .icons div {
                display: inline-block;
                border: 3px solid transparent;
                margin: 2px;
                vertical-align: middle;
            }

            .icons img {
                height: auto;
                width: 100%;
                max-width: 40px;
                max-height: 40px;
                vertical-align: middle;
            }

        .active {
            border: 3px solid #7F9293 !important;
            display: inline-block;
        }
    </style>
}

<ol class="breadcrumb">
    <li>@Html.ActionLink("Home", MVC.Home.Index())</li>
    <li>@Html.ActionLink("Products", MVC.Admin.Product.List())</li>
    <li class="active">@Html.ActionLink("Layout", MVC.Admin.Product.Layout(Model.ProductId))</li>
</ol>

<h2>Product Layout</h2>

<div class="container col-sm-12">
    <p>Use this tool to specify placement of logo and text</p>

    <form action="/admin/api/fileupload" method="post" enctype="multipart/form-data">
        <div class="form-horizontal">
            <div class="form-group" id="uploadControls">
                <label class="control-label col-md-2">Upload Image</label>
                <div class="col-md-10">
                    <input id="fileUpload" type="file" />
                </div>
            </div>
            <div id="uploadProgress" class="hidden">
                <img src="/content/images/ajax-loader.gif" alt=""/>
            </div>
        </div>
    </form>
</div>
<div class="container col-sm-12">
    <div class="col-md-7 ">
        <canvas id="c" name="productname" width="500" height="500"></canvas>
    </div>
    <div id="contents" class="well col-md-4 col-md-offset-0 col-sm-12"></div>

    <div class="well col-md-4 col-md-offset-0 col-sm-12">
        <input id="addPic" type="button" value="Add Pic" class="btn btn-success" />
        <input id="addText" type="button" value="Add Text" class="btn btn-primary" />
        <input id="removeObject" type="button" value="Remove" class="btn btn-danger" />
        <a id="download" name="productname">Download Test</a>
    </div>
</div>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    @Html.HiddenFor(model => model.ProductId)

    <div class="form-horizontal">

        @Html.HiddenFor(model => model.Configuration)
        @Html.HiddenFor(model => model.CanvasImage)
    </div>
}


@section Scripts {
    <script src="@Links.Scripts.product_canvas.canvas_js"></script>
    <script src="@Links.Scripts.product_canvas.wordwrap_js"></script>
    <script src="@Links.Scripts.Areas.Admin.Product.Layout_js"></script>
    <script>
        var imageUpload = {
            buttonUpload: "#btnUpload",
            containerControls: "#uploadControls",
            containerProgress: "#uploadProgress",
            fileUpload: "#fileUpload",
            containerResults: "#uploadResults",
            controlImage: "#CanvasImage"
        };
    </script>
    <script>
        (function() {
            var lcOptions = {
                controlAddPic: "#addPic",
                controlAddText: "#addText",
                controlRemoveText: "#removeObject",
                controlDownload: "#download",
                inputConfiguration: "#Configuration",
                config: ""
            };
            var lc = new layoutCanvas(lcOptions);

            function showUploadControls() {
                $(imageUpload.containerControls).show();
                $(imageUpload.containerProgress).hide();
            }

            function showUploadProgress() {
                $(imageUpload.containerControls).hide();
                $(imageUpload.containerProgress).show();
            }

            function clearFileInput(controlId) {
                var oldInput = $(controlId);
                if (typeof oldInput !== "undefined" && oldInput !== null) {
                    oldInput.replaceWith(oldInput.val('').clone(true));
                }
            }

            function onUpload(evt) {
                var files = $(imageUpload.fileUpload).get(0).files;
                if (files.length > 0) {

                    showUploadProgress();

                    if (window.FormData !== undefined) {
                        var data = new FormData();
                        for (i = 0; i < files.length; i++) {
                            data.append("file" + i, files[i]);
                        }
                        $.ajax({
                            type: "POST",
                            url: "/admin/api/fileupload",
                            contentType: false,
                            processData: false,
                            data: data,
                            success: function(results) {
                                //$(imageUpload.containerResults).empty();
                                for (var i = 0; i < results.length; i++) {
                                    //$(imageUpload.containerResults).append($("<li/>").text(results[i]));
                                    var url = results[i];
                                    lc.updateCanvas(url); // update canvas url
                                    $(imageUpload.controlImage).val(url); // save image url to CanvasImage hidden field
                                    clearFileInput(imageUpload.fileUpload);
                                }
                                showUploadControls();
                            },
                            error: function(xhr, ajaxOptions, thrownError) {
                                showUploadControls();
                                //alert(xhr.responseText);
                            }
                        });
                    }
                    //else {
                        //alert("Your browser doesn't support HTML5 multiple file uploads! Please use some decent browser.");
                    //}
                }
            }

            $(document).ready(function() {
                console.log(imageUpload.buttonUpload);
                $(imageUpload.buttonUpload).click(onUpload);
            });
        }).call(this);
    </script>

}
